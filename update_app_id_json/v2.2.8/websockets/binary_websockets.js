define(["exports","jquery","text!../oauth/app_id.json","common/util"],function(e,t,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.sell_expired=e.is_authenticated=e.send=e.cached=e.switch_account=e.execute=e.proposal_open_contract=e.events=e.invalidate=e.server_url=e.app_id=e.socket_url=void 0;var a=r(t),i=r(n);function r(e){return e&&e.__esModule?e:{default:e}}function o(){return localStorage.getItem("config.server_url")||"frontend.binaryws.com"}function s(){var e=(local_storage.get("i18n")||{value:"en"}).value,t=new WebSocket(_+"?l="+e+"&app_id="+g);return t.addEventListener("open",S),t.addEventListener("close",p),t.addEventListener("message",q),t.addEventListener("error",function(e){a.default.growl.error({message:"Connection error.".i18n()}),p()}),t}function c(){return l&&1===l.readyState}var u=!1,l=null,f=!1,d={},_=e.socket_url="wss://"+o()+"/websockets/v3",g=e.app_id=localStorage.getItem("config.app_id")||function(){var e=JSON.parse(i.default),t=window.location.href,n="";for(var r in e)if(0===t.lastIndexOf(r,0)){n=e[r];break}var o=n||11;return localStorage.setItem("config.app_id",o),o}(),h=e.server_url=o(),v=!1,p=function(){require(["windows/tracker"],function(e){var t=e.get_trade_dialogs(),n=e.get_unique_dialogs();u=!1,N("logout"),v||(v=!0,setTimeout(function(){v=!1,l=s(),local_storage.get("oauth")&&I.cached.authorize().then(function(){e.reopen_trade_dialogs(t),setTimeout(function(){return e.reopen_unique_dialogs(n)},0)}).catch(function(e){a.default.growl.error({message:e.message})})},1e3))})},m={},b=[],w=[],y={},x={},S=function(){for(l.send(JSON.stringify({website_status:1,subscribe:1}));0<w.length;){var e=w.shift();y[e.req_id]||l.send(JSON.stringify(e))}for(var t in y){var n=y[t];n&&(n.sent_before?n.reject({message:"Connection closed.".i18n()}):(n.sent_before=!0,l.send(JSON.stringify(n.data))))}for(;0<b.length;)b.shift()()},q=function(e){var n=JSON.parse(e.data);m[n.msg_type]=m[n.msg_type]||[];for(var t=function(e){var t=m[n.msg_type][e];setTimeout(function(){return t(n)},0)},r=0;r<m[n.msg_type].length;r++)t(r);var o=n.req_id,a=y[o]||d[o];a&&(delete y[o],delete d[o],n.error?(n.error.echo_req=n.echo_req,n.error.req_id=n.req_id,a.reject(n.error)):a.resolve(n))};l=s();function O(e){for(var t in{balance:1,statement:1,profit_table:1,portfolio:1,proposal_open_contract:1,buy:1,sell:1,get_self_exclusion:1,set_self_exclusion:1})if(t in e)return 1}function j(n){return n.req_id=++z,new Promise(function(e,t){f?(y[n.req_id]={resolve:e,reject:t,data:n},c()?l.send(JSON.stringify(n)):w.push(n)):d[n.req_id]={resolve:e,reject:t,data:n}})}function k(e){var r=!1,o={authorize:e},a=JSON.stringify(o),i=j(o);return i.then(function(e){u=!0,local_storage.set("authorize",e.authorize);var t=-1!==e.authorize.landing_company_name.indexOf("japan");if(t||N("login",e),local_storage.get("oauth-login")){var n=local_storage.get("oauth-login").value;local_storage.remove("oauth-login"),n&&!t&&N("oauth-login",e)}return r=!0,x[a]={data:o,promise:i},e}).catch(function(e){throw"SelfExclusion"===e.code||r||(u=!1,N("logout"),local_storage.remove("oauth")),delete x[a],e})}var z=0,J=e.invalidate=function(){for(var e in local_storage.remove("oauth"),local_storage.remove("authorize"),N("reset_realitycheck"),N("reset_accountstatus"),I.send({logout:1}).catch(function(e){a.default.growl.error({message:e.message}),l.close()}),x)(O(x[e].data)||"authorize"in x[e].data)&&delete x[e];u=!1},N=function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];(m[e]||[]).forEach(function(e){setTimeout(function(){return e.apply(void 0,n)},0)})},P={},T={},E={},I={events:e.events={on:function(e,t){return(m[e]=m[e]||[]).push(t),t},off:function(e,t){if(m[e]){var n=m[e].indexOf(t);-1!==n&&m[e].splice(n,1)}},on_till:function(t,n){I.events.on(t,function e(){n.apply(void 0,arguments)&&I.events.off(t,e)})}},proposal_open_contract:e.proposal_open_contract={subscribe:function(t){if(T[t]&&0<T[t].subscribers)return T[t].subscribers++,T[t].promise;var e=I.send({proposal_open_contract:1,contract_id:t,subscribe:1}).then(function(e){return T[t].stream_id=e.proposal_open_contract.id,e}).catch(function(e){throw T[t]=void 0,e});return T[t]={subscribers:1,promise:e},e},forget:function(t){var n=T[t],e=E[t];if(!n)return e||Promise.resolve();if(0==n.subscribers)return e;if(n.subscribers--,0<n.subscribers)return Promise.resolve();function r(){return T[t]=void 0,I.send({forget:n.stream_id}).catch(function(e){throw E[t]=void 0,e}).then(function(e){return E[t]=void 0,e}).catch(function(e){a.default.growl.error({message:e.message})})}return n.stream_id?E[t]=r():E[t]=n.promise.catch(function(e){}).then(function(e){return n.stream_id?r():void 0}).catch(function(e){a.default.growl.error({message:e.message})}),E[t]}},execute:e.execute=function(e){c()?setTimeout(e,0):b.push(e)},switch_account:e.switch_account=function(e){var t=local_storage.get("oauth");if(!t)return Promise.reject({message:"Account token not found.".i18n()});var n=t.map(function(e){return e.id}).indexOf(e);if(-1===n)return promise.reject({message:"Account id not found.".i18n()});var r=t[n];for(var o in t.splice(n,1),t.unshift(r),local_storage.set("oauth",t),x)(O(x[o].data)||"authorize"in x[o].data)&&delete x[o];return u=!1,I.send({forget_all:"transaction"}).catch(function(e){}),I.send({forget_all:"balance"}).catch(function(e){}),I.cached.authorize().then(function(e){return N("switch_account",e)}).catch(function(e){a.default.growl.error({message:e.message})})},cached:e.cached={send:function(e){var t=JSON.stringify(e);return x[t]?x[t].promise:(x[t]={data:e,promise:null},x[t].promise=I.send(e).then(function(e){return e},function(e){throw delete x[t],e}).catch(function(e){a.default.growl.error({message:e.message})}))},authorize:function(e){var t=local_storage.get("oauth"),n=t&&t[0]&&t[0].token,r=JSON.stringify({authorize:n});return u&&n&&x[r]&&!e?x[r].promise:n?k(n):Promise.reject("Please log in.".i18n())}},send:e.send=function(e,t){if(e&&O(e))return function(e){if(u)return j(e);var t=j.bind(null,e);if(local_storage.get("oauth")){var n=local_storage.get("oauth")[0].token;return k(n).then(t).catch(function(e){a.default.growl.error({message:e.message})})}return Promise.reject({message:"Please log in".i18n()})}(e);var n,r=j(e);return t&&(n=e.req_id,setTimeout(function(){var e=y[n];e&&(delete y[n],e.reject({message:"Timeout for websocket request".i18n()}))},t)),r},is_authenticated:e.is_authenticated=function(){return u},sell_expired:e.sell_expired=function(e){var t=(new Date).getTime()/1e3|0;!P[e=e||1+t]&&t<+e&&(P[e]=setTimeout(function(){P[e]=void 0,I.send({sell_expired:1}).catch(function(e){})},1e3*(e+2-t)))},invalidate:J,app_id:g,socket_url:_,server_url:h};I.events.on("website_status",function(e){if(f=e.website_status&&"up"===e.website_status.site_status.toLowerCase())for(var t in d)d[t].is_sent||(l.send(JSON.stringify(d[t].data)),d[t].is_sent=1)}),I.events.on("login",function(){I.send({transaction:1,subscribe:1}).catch(function(e){}),I.send({balance:1,subscribe:1}).catch(function(e){})}),I.events.on("logout",function(){I.send({forget_all:"transaction"}).catch(function(e){}),I.send({forget_all:"balance"}).catch(function(e){})}),setInterval(function(){return I.send({ping:1})},3e4),e.default=I});